<!DOCTYPE html>

<html ng-app="irc">
	<head>
		<title>HPI Push Notifications</title>
		<meta charset="utf-8">
		<link href="/css/bootstrap.min.css" rel="stylesheet">
		<!--<link href="/css/bootstrap-theme.min.css" rel="stylesheet">-->
		<link href="/css/custom-style.css" rel="stylesheet">
	</head>

	<body ng-controller="PostsController">

		<nav class="navbar navbar-default" role="navigation">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button"
							class="navbar-toggle collapsed"
							data-toggle="collapse"
							data-target="#navcollapse">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="/">IRC Bot</a>
				</div>

				<div class="collapse navbar-collapse" id="navcollapse">
					<ul class="nav navbar-nav">

						<form class="navbar-form navbar-left">
							<div class="input-group">
								<input ng-bind="newServer"
										type="text"
										class="form-control"
										placeholder="Connect to Server ...">
								<span class="input-group-btn">
									<button ng-click="connectServer(newServer)"
											class="btn btn-default">
										<span class="glyphicon glyphicon-cloud"></span>
									</button>
								</span>
							</div>
						</form>

						<form class="navbar-form navbar-left">
							<div class="input-group">
								<input ng-model="newChannel"
			   							ng-disabled="!currentServer"
										type="text"
										class="form-control"
										placeholder="Join channel ...">
								<span class="input-group-btn">
									<button ng-disabled="!currentServer"
											 ng-click="joinChannel(newChannel); newChannel = ''"
											class="btn btn-default">
										<span class="glyphicon glyphicon-plus"></span>
									</button>
								</span>
							</div>
						</form>

					</ul>

					<ul class="nav navbar-nav navbar-right">

						<li>
							<a href="#">
								<span class="glyphicon glyphicon-log-out"></span>
								Logout
							</a>
						</li>

					</ul>
				</div>
			</div>
		</nav>

		<div class="container">

			<div class="col-xs-3">

				<div ng-repeat="(serverName, server) in state.servers">
					<h4>{{ serverName }}</h4>

					<ul class="list-group">
						<li ng-repeat="(channelName, channel) in server.channels"
		  					ng-click="selectChannel(serverName, channel)"
		 					ng-class="{ active: currentChannel == channel }"
							class="list-group-item">
							<span class="badge">{{ channel.unreadCount }}</span> {{ channelName }}
						</li>
					</ul>
				</div>

			</div>

			<div class="col-xs-7">
				<div id="messages">
					<div class="message" ng-repeat="message in currentChannel.messages">
						<span style="color: {{ getColorForSender(message.sender) }}"
							class="sender">{{ message.sender }}:</span> {{ message.text }}
					</div>
				</div>

				<div class="input-group">
					<input class="form-control"
							id="input"
	   						ng-enter="sendMessage()"
							placeholder="Message ..."
							ng-model="newMessage">
					<span class="input-group-btn">
						<button ng-click="sendMessage()" class="btn btn-default">
							<span class="glyphicon glyphicon-circle-arrow-right"></span>
						</button>
					</span>
				</div>
			</div>

			<div class="col-xs-2">
				<div id="user-list" style="color: {{ getColorForSender(user) }}"
					ng-repeat="user in currentChannel.users | orderBy">{{ user }}</div>
			</div>

		</div>
	</body>

	<script src="http://cloud.tombeckmann.de/socket.io/socket.io.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script>

		var socket = io.connect('http://cloud.tombeckmann.de');

		var colors = ['#0099cc', '#9933cc', '#669900', '#ff8800', '#cc0000'];
		var colorsIndex = 0;

		angular.module('irc', [])
			.controller('PostsController', function($scope, $timeout) {

				$scope.colors = {};

				$scope.selectChannel = function(server, channel) {
					$scope.currentChannel = channel;
					$scope.currentServer = server;

					$timeout(function() {
						$messages = $('#messages');
						$messages.scrollTop($messages[0].scrollHeight);

						$('#input').focus();
					});
				};

				$scope.getColorForSender = function(sender) {
					if (!$scope.colors[sender])
						$scope.colors[sender] = colors[colorsIndex++ % colors.length];

					return $scope.colors[sender];
				};

				$scope.joinChannel = function(channel) {
					socket.emit('join-channel', {
						server: $scope.currentServer,
						channel: channel
					});
				};

				$scope.sendMessage = function() {
					var channels = $scope.state.servers[$scope.currentServer].channels;

					for (var channel in channels) {
						if (channels[channel] == $scope.currentChannel)
						   break;
					}

					$scope.currentChannel.messages.push({
						sender: $scope.state.nick,
						text: $scope.newMessage,
						read: true
					});

					socket.emit('send-message', {
						server: $scope.currentServer,
						channel: channel,
						message: $scope.newMessage
					});

					$scope.newMessage = '';

					$('#input').focus();
				};

				$scope.resize = function() {
					$messages = $('#messages');
					$messages.height($(document.body).height() - $('#input').outerHeight(true) - $messages.offset().top);
				};

				$scope.resize();
				window.onresize = $scope.resize;

				$scope.$watch('currentChannel.messages', function() {
					$scope.$evalAsync(function() {
						$messages = $('#messages');
						var currentY = $messages.scrollTop() + $messages.height();
						var height = $messages[0].scrollHeight;

						if (height - currentY < 100)
							$messages.scrollTop(height + 9999);
					});
				}, true);

				socket.on('init', function(initdata) {
					$scope.$apply(function() {
						$scope.state = initdata.state;

						var servers = Object.keys($scope.state.servers);
						if (servers.length) {
							var channels = $scope.state.servers[servers[0]].channels;
							var keys = Object.keys(channels);
							if (keys.length)
								$scope.selectChannel(servers[0], channels[keys[0]]);
						}
					});
				});

				socket.on('data-update', function(updates) {
					$scope.$apply(function() {
						updates.forEach(function(update) {
							var path = update.path.split('|');
							var currentElement = $scope.state;
							var key = path[path.length - 1];

							for (var i = 0; i < path.length - 1; i++) {
								currentElement = currentElement[path[i]];
							}

							switch (update.op) {
								case 'set':
									currentElement[key] = update.val;
									break;
								case 'unset':
									delete currentElement[key];
									break;
								case 'add':
									currentElement[key].push(update.val);
									break;
								case 'remove':
									currentElement[key].splice(currentElement[key].indexOf(update.val), 1);
									break;
							}
						});
					});
				});
			})
			.directive('ngEnter', function () {
				return function (scope, element, attrs) {
					element.bind("keydown keypress", function (e) {
						if (e.which === 13) {
							scope.$apply(function (){
								scope.$eval(attrs.ngEnter);
							});

							e.preventDefault();
						}
					});
				};
			});

	</script>
</html>
